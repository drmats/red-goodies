<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>reducer.ts - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-redux.html">redux</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~actionCreators">actionCreators</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~bindActionCreator">bindActionCreator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~bindActionCreators">bindActionCreators</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~bindActionCreatorsTree">bindActionCreatorsTree</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~createReducer">createReducer</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~defineActionCreator">defineActionCreator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~emptyActionCreators">emptyActionCreators</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~isNumberActionType">isNumberActionType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~isStringActionType">isStringActionType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~isWithPayload">isWithPayload</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~payloadActionCreators">payloadActionCreators</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-redux.html#~sliceReducer">sliceReducer</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">reducer.ts</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Redux reducer tools.
 *
 * @module redux
 * @license Apache-2.0
 * @author drmats
 */

/* eslint-disable @typescript-eslint/no-explicit-any */




import type {
    Fun,
    SafeKey,
} from "@xcmats/js-toolbox/type";
import {
    choose,
    identity,
} from "@xcmats/js-toolbox/func";
import type {
    Action,
    ActionCreator,
    EmptyActionCreator,
    PayloadAction,
    PayloadActionCreator,
    ReduxCompatAction,
    ReduxCompatAnyAction,
} from "./action";
import { isWithPayload } from "./action";




/**
 * redux-compatible Reducer type.
 */
export type ReduxCompatReducer&lt;
    StateType = any,
    ActionShape extends ReduxCompatAction = ReduxCompatAnyAction,
> = (
    state: StateType | undefined,
    action: ActionShape,
) => StateType;




/**
 * Reducer - function taking state and action and returning a new state.
 */
export type Reducer&lt;
    StateType = any,
    PayloadType = any,
    ActionType extends SafeKey = SafeKey,
> = (
    state: StateType,
    action: Action&lt;PayloadType, ActionType>,
) => StateType;




/**
 * Create clean and readable reducers for redux.
 *
 * @function createReducer
 * @param initState
 * @returns {ReduxBoundReducer}
 */
export function createReducer&lt;StateType> (initState: StateType): (
    reducers: Record&lt;SafeKey, Reducer&lt;StateType>>,
    defaultReducer?: Reducer&lt;StateType>,
) => ReduxCompatReducer&lt;StateType, Action> {
    return (reducers, defaultReducer = identity) =>
        (state = initState, action) =>
            choose(
                action.type,
                reducers,
                defaultReducer,
                [state, action],
            );
}




/**
 * Chainable API for building reducer handling a slice of state.
 */
interface SliceBuildAPI&lt;StateType> {
    // handle empty action (overload)
    handle&lt;ActionType extends SafeKey> (
        actionCreator: EmptyActionCreator&lt;ActionType>,
        reducer: (state: Readonly&lt;StateType>) => Readonly&lt;StateType>,
    ): SliceBuildAPI&lt;StateType>;
    // handle action with payload (overload)
    handle&lt;ActionType extends SafeKey, PayloadType> (
        actionCreator: PayloadActionCreator&lt;PayloadType, ActionType>,
        reducer: (
            state: Readonly&lt;StateType>,
            payload: PayloadType,
        ) => Readonly&lt;StateType>,
    ): SliceBuildAPI&lt;StateType>;
    // handle unmatched actions
    default (
        reducer: (
            state: Readonly&lt;StateType>,
            action: Action,
        ) => Readonly&lt;StateType>,
    ): SliceBuildAPI&lt;StateType>;
    // match actions using type predicate - useful for matching actions
    // by payload content (overload)
    match &lt;PayloadType>(
        predicate: (action: Action) => action is Action&lt;PayloadType>,
        reducer: (
            state: Readonly&lt;StateType>,
            payload: PayloadType,
        ) => Readonly&lt;StateType>,
    ): SliceBuildAPI&lt;StateType>;
    // match action using boolean predicate - useful for matching actions
    // using string operations on their type (overload)
    match (
        predicate: (action: Action) => boolean,
        reducer: (state: Readonly&lt;StateType>) => Readonly&lt;StateType>,
    ): SliceBuildAPI&lt;StateType>;
}




/**
 * Statically typed reducer for a slice of state.
 *
 * @function sliceReducer
 * @param initState
 * @returns (builder: (slice: SliceBuildAPI) => void) => ReduxCompatReducer
 */
export function sliceReducer&lt;StateType> (initState: StateType): (
    builder: (slice: SliceBuildAPI&lt;StateType>) => void,
) => ReduxCompatReducer&lt;Readonly&lt;StateType>, Action> {

    let
        reducers = {} as Record&lt;SafeKey, Fun>,
        matchers = [] as ReduxCompatReducer&lt;Readonly&lt;StateType>, Action>[],
        defaultReducer: (
            state: Readonly&lt;StateType>,
            action: Action,
        ) => Readonly&lt;StateType>;

    const
        create = createReducer(initState),
        slice: SliceBuildAPI&lt;StateType> = {
            // handle concrete type of action
            handle: &lt;ActionType extends SafeKey, PayloadType>(
                actionCreator: ActionCreator&lt;PayloadType, ActionType>,
                reducer: (
                    state: Readonly&lt;StateType>,
                    payload?: PayloadType,
                ) => Readonly&lt;StateType>,
            ): typeof slice => {
                if (reducer.length === 2) {
                    reducers[actionCreator.type] = (
                        state: Readonly&lt;StateType>,
                        action: PayloadAction&lt;PayloadType, ActionType>,
                    ) => reducer(state, action.payload);
                } else {
                    reducers[actionCreator.type] = (
                        state: Readonly&lt;StateType>,
                    ) => reducer(state);
                }
                return slice;
            },
            // handle unmatched actions (state identity by default)
            default: (reducer) => {
                defaultReducer = reducer;
                return slice;
            },
            // additionally match actions using predicate (matcher is run
            // against all actions - handled and unhandled earlier)
            match: &lt;PayloadType>(
                predicate: (action: Action) => boolean,
                reducer: (
                    state: Readonly&lt;StateType>,
                    payload?: PayloadType,
                ) => Readonly&lt;StateType>,
            ): typeof slice => {
                matchers.push(
                    (state, action) =>
                        predicate(action) ?
                            isWithPayload(action) ?
                                reducer(state || initState, action.payload) :
                                reducer(state || initState) :
                            state || initState,

                );
                return slice;
            },
        };

    // function building actual reducer based on provided builder function
    return (builder) => {

        // build `reducers` object and `matchers` array
        builder(slice);

        // create main (slice) reducer
        const reducer = defaultReducer ?
            create(reducers, defaultReducer) :
            create(reducers);

        // return reducer that is also applying all defined matchers
        return (state, action) => {
            let localState = reducer(state, action);
            for (const match of matchers) {
                localState = match(localState, action);
            }
            return localState;
        };

    };

}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Sat Oct 09 2021 09:22:17 GMT+0200 (Central European Summer Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
